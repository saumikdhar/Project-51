image: node:12-alpine

stages:
   - build
   - test
   - dockerise
   - deploy

cache:
  paths:
    - ./project-management-frontend/node_modules
    - ./project-management-backend/node_modules

build-react:
  stage: build
  tags:
    - comsc-ci
  script:
   - cd project-management-frontend
   - npm install
   - echo "Finished installing node_modules"
   - echo "Building..."
   - CI=false npm run build
   - cd ..
  artifacts:
    paths: 
      - ./project-management-frontend/node_modules
      - ./project-management-frontend/build

build-node:
  stage: build
  tags:
    - comsc-ci
  script:
    - echo "Installing dependencies for Node" 
    - echo "Running npm install..."
    - cd project-management-backend
    - npm install
    - cd ..
  artifacts:
    paths: 
      - ./project-management-backend/node_modules

# test-react:
#   stage: test
#   tags:
#     - comsc-ci  
#   script:
#     - echo "Running React test..."
#     - cd project-management-frontend
#     - npm i react-scripts
#     - npm test
#     - echo "Test successful!"

# test-node:
#   stage: test
#   tags:
#     - comsc-ci
#   script:
#     - cd project-management-backend
#     - echo "Running Node test..."
#     - npm test
#     - echo "Test successful!"

docker-image:
  image: docker:latest
  services:
    - docker:dind
  stage: dockerise
  tags: 
    - comsc-ci
  variables:
#     # Tell docker CLI how to talk to Docker daemon; see
#     # https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-executor
    DOCKER_HOST: tcp://docker:2375/
#     # Use the overlayfs driver for improved performance:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: ""  
  script:
    - echo "login to GitLab"
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.git.cf.ac.uk

    - cd ./project-management-frontend

    - echo "building docker image for React"
    - docker build -f Dockerfile.prod --pull -t registry.git.cf.ac.uk/c1824227/project-51/frontend .

    - echo "pushing docker-React image to Git"
    - docker push registry.git.cf.ac.uk/c1824227/project-51/frontend .

    - cd ..
    - cd ./project-management-backend
    - echo "building docker image for Node"
    - docker build -t registry.git.cf.ac.uk/c1824227/project-51/backend .

    - echo "pushing docker-React image to Git"
    - docker push registry.git.cf.ac.uk/c1824227/project-51/backend .

deploy-prod:
  tags:
    - comsc-ci
  stage: deploy
  image: openshift/origin-cli
  script:
    - ls -a
    - echo "Openshift login"
    - oc login https://$OPENSHIFT_SERVER:$OPENSHIFT_PORT --token=$OPENSHIFT_TOKEN

    # run the code below only once to create the secret
    -  oc create secret docker-registry gitlab-container-auth --docker-server=https://registry.git.cf.ac.uk --docker-username=c1824227 --docker-password=$DOCKER_PASSWORD --docker-email=dhars@cardiff.ac.uk

    # The same code must be run twice as there is a 2-factor authentication one from gitlab and the other from registry
    - oc create secret docker-registry gitlab-auth --docker-server=https://git.cardiff.ac.uk --docker-username=c1824227 --docker-password=$DOCKER_PASSWORD --docker-email=dhars@cardiff.ac.uk

    - oc secrets link default gitlab-container-auth --for=pull
    - oc secrets link default gitlab-auth --for=pull
    
    - oc new-app --docker-image registry.git.cf.ac.uk/c1824227/project-51/frontend:latest --name=sbos
    - oc start-build sbos --from-dir=.
    - oc expose service sbos

    - oc import-image registry.git.cf.ac.uk/c1824227/project-51/frontend --confirm
    - oc get service sbos || oc new-app project-51-test --name sbos
    - oc get service sbos || oc expose service sbos-1 --port 3000

